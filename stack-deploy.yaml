imports:
- path: subnetwork.jinja
- path: service-tier.jinja
- path: l3-load-balancer.jinja
- path: startup-script.sh


resources:

######################################################
## NETWORK and SUBNETS
######################################################

- name: test-network
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false
    region: us-east1

- name: public-subnet
  type: subnetwork.jinja
  properties:
    cidr: 10.155.192.0/19
    subnet_name: public-subnet
    region: us-east1

- name: app-web-subnet
  type: subnetwork.jinja
  properties:
    cidr: 10.155.0.0/18
    subnet_name: app-web-subnet
    region: us-east1

- name: db-subnet
  type: subnetwork.jinja
  properties:
    cidr: 10.155.128.0/19
    subnet_name: db-subnet
    region: us-east1



######################################################
## FIREWALL RULES
######################################################

# Allow HTTP and HTTPS from any source
- name: fw-allow-http-https
  type: compute.v1.firewall
  properties:
    network: $(ref.test-network.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    targetTags:
    - http-server
    - https-server
    allowed:
    - IPProtocol: TCP
      ports: ["80","443"]

# Allow ICMP and SSH from any source
- name: fw-allow-icmp-ssh
  type: compute.v1.firewall
  properties:
    network: $(ref.test-network.selfLink)
    sourceRanges: ["0.0.0.0/0"]
    allowed:
    - IPProtocol: TCP
      ports: ["22"]
    - IPProtocol: ICMP

# Allow any traffic from the app-web tier
- name: fw-allow-appweb-tier
  type: compute.v1.firewall
  properties:
    network: $(ref.test-network.selfLink)
    sourceRanges: [$(ref.app-web-subnet.ipCidrRange)]
    allowed:
    - IPProtocol: TCP
      ports: ["0-65535"]
    - IPProtocol: UDP
      ports: ["0-65535"]
    - IPProtocol: ICMP

# Allow any traffic from the DB tier
- name: fw-allow-db-tier
  type: compute.v1.firewall
  properties:
    network: $(ref.test-network.selfLink)
    sourceRanges: [$(ref.db-subnet.ipCidrRange)]
    allowed:
    - IPProtocol: TCP
      ports: ["0-65535"]
    - IPProtocol: UDP
      ports: ["0-65535"]
    - IPProtocol: ICMP


######################################################
## INSTANCE GROUPS
######################################################

## Create Web service tier
- name: web
  type: service-tier.jinja
  properties:
    subnetwork: app-web-subnet
    zones:
    - us-east1-b
    - us-east1-d
    tag: http-server
    minSize: 1
    maxSize: 2
    externalIP: true

## Create App service tier
- name: app
  type: service-tier.jinja
  properties:
    subnetwork: app-web-subnet
    zones:
    - us-east1-b
    - us-east1-d
    tag: app-server
    minSize: 1
    maxSize: 2
    externalIP: true

######################################################
## LOAD BALANCERS
######################################################

- name: web-lb
  type: l3-load-balancer.jinja
  properties:
    port: 80
    service-name: web
    zones:
    - us-east1-b
    - us-east1-d
